name: Sharly-Chess UAC export

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag to build'
        required: true
  push:
    tags:
      - '*'

permissions:
  contents: write

jobs:
  export-sharly-chess-uac-windows:
    # Next job export-sharly-chess-windows needs to run on a Windows self-hosted GitHub runner
    # for cloud code-signing. If the job doesn't start, it is probably because GitHub did not
    # find a self-hosted runner with label 'your-github-id'.
    # In this case, check the labels of your runners.
    runs-on: windows-latest
    steps:
      # Get the current date to set the title of the release
      - name: Get current date
        id: date
        uses: Kaven-Universe/github-action-current-date-time@v1
        with:
          format: "YYYY_MM_DD HH_mm_ss_SSS"
      - name: Checkout repository
        uses: actions/checkout@v4.2.2
      - name: Setup Python
        uses: actions/setup-python@v5.5.0
        with:
          # Version range or exact version of Python or PyPy to use, using SemVer's version range syntax. Reads from .python-version if unset.
          # NOTE(pascalaubry): on Windows self-hosted runners, the first install fails:
          # https://github.com/actions/setup-python/issues/969
          python-version: 3.13
      - name: Install dependencies
        shell: cmd  # pwsh is not found on Windows self-hosted runners (https://github.com/actions/runner/issues/3415)
        run: |
          pip install -e .[export]
      - name: Set version variable
        id: version
        shell: bash
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${{ github.ref_name }}"
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Using version: ${VERSION}"
      - name: Generate ZIP file
        shell: powershell
        run: |
          python scripts/export/export.py --github="${{ steps.version.outputs.version }}"
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: sharly-chess-uac-${{ steps.version.outputs.version }}
          path: |
            export/sharly-chess-uac-${{ steps.version.outputs.version }}.zip

  create-release:
    needs: [export-sharly-chess-uac-windows]
    runs-on: ubuntu-latest
    steps:
      - name: Get current date
        id: date
        uses: Kaven-Universe/github-action-current-date-time@v1
        with:
          format: "YYYY_MM_DD HH_mm_ss_SSS"
      - name: Set version variable
        id: version
        shell: bash
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${{ github.ref_name }}"
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Using version: ${VERSION}"
      - name: Checkout repository
        uses: actions/checkout@v4.2.2
      - name: Download Windows artifacts
        uses: actions/download-artifact@v4
        with:
          name: sharly-chess-${{ steps.version.outputs.version }}
          path: export-windows/
      - name: Rename artifacts with platform suffix
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          mkdir -p release-files
          # Windows files
          cp export-windows/sharly-chess-uac-${VERSION}.zip release-files/sharly-chess-uac-${VERSION}.zip
      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: "Version ${{ steps.version.outputs.version }} (${{ steps.date.outputs.year }}-${{ steps.date.outputs.month }}-${{ steps.date.outputs.day }})"
          draft: true
          prerelease: contains(steps.version.outputs.version, 'a') || contains(steps.version.outputs.version, 'b') || contains(steps.version.outputs.version, 'rc')
          files: |
            release-files/sharly-chess-uac-${{ steps.version.outputs.version }}.zip
          body_path: RELEASE_NOTES.md
